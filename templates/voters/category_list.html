{% extends 'voters/base_voters.html' %}
{% load humanize %}

{% block content %}
<!-- Page Title -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Categories</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'voters:dashboard' %}">Voters</a></li>
                    <li class="breadcrumb-item active">Categories</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="stats-card">
            <div class="stats-icon primary">
                <i class="las la-folder"></i>
            </div>
            <div class="stats-value">{{ stats.total_categories|intcomma|default:0 }}</div>
            <div class="stats-label">Total Categories</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stats-card">
            <div class="stats-icon success">
                <i class="las la-file-excel"></i>
            </div>
            <div class="stats-value">{{ stats.categories_with_excel|intcomma|default:0 }}</div>
            <div class="stats-label">With Voter Data</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stats-card">
            <div class="stats-icon info">
                <i class="las la-map-marker"></i>
            </div>
            <div class="stats-value">{{ categories|length }}</div>
            <div class="stats-label">Root Categories</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stats-card">
            <div class="stats-icon warning">
                <i class="las la-search"></i>
            </div>
            <a href="{% url 'voters:voter_list' %}" class="stats-value text-decoration-none">Search</a>
            <div class="stats-label">Find Voters</div>
        </div>
    </div>
</div>

<!-- Search Filter -->
<div class="filter-panel mb-4">
    <div class="filter-header" data-bs-toggle="collapse" data-bs-target="#categoryFilterCollapse" aria-expanded="true">
        <h6><i class="las la-search me-2"></i>Search Categories</h6>
        <i class="las la-chevron-down fs-4"></i>
    </div>
    <div class="collapse show" id="categoryFilterCollapse">
        <div class="mt-3 p-3">
            <div class="search-box-modern">
                <i class="las la-search search-icon"></i>
                <input type="text" class="form-control" id="categorySearch" 
                       placeholder="Search by category name or area code...">
            </div>
        </div>
    </div>
</div>

<!-- Category Tree -->
<div class="card-modern">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
        <h5 class="mb-0">
            <i class="las la-sitemap me-2"></i>Category Hierarchy 
            <span class="badge bg-primary-subtle text-primary ms-2" id="categoryCount">{{ categories|length }} categories</span>
        </h5>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="expandAllCategories()">
                <i class="las la-expand-arrows-alt me-1"></i> Expand All
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="collapseAllCategories()">
                <i class="las la-compress-arrows-alt me-1"></i> Collapse All
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        {% if categories %}
        <div class="category-tree p-3" id="categoryTree">
            {% for category in categories %}
            <div class="category-item-wrapper" data-category-name="{{ category.name|lower }}" data-category-code="{{ category.code|default:'' }}">
                <div class="category-item">
                    <div class="category-info">
                        <div class="category-icon {% if category.has_excel %}has-excel{% else %}no-excel{% endif %}">
                            {% if category.has_excel %}
                            <i class="las la-folder-open"></i>
                            {% else %}
                            <i class="las la-folder"></i>
                            {% endif %}
                        </div>
                        <div>
                            <div class="category-name">{{ category.name }}</div>
                            <div class="category-meta">
                                {% if category.code %}<span class="badge bg-light text-dark me-2">Code: {{ category.code }}</span>{% endif %}
                                {% if category.has_excel %}<span class="badge bg-success-subtle text-success">Has Data</span>{% endif %}
                                <span class="text-muted ms-2">{{ category.children.count }} subcategories</span>
                            </div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <a href="{% url 'voters:category_detail' category.pk %}" class="btn btn-icon btn-soft-primary" title="View Details">
                            <i class="las la-eye"></i>
                        </a>
                        {% if category.children.exists %}
                        <button type="button" class="btn btn-icon btn-soft-secondary toggle-children" 
                                onclick="toggleChildren(this)" title="Toggle Subcategories">
                            <i class="las la-chevron-down"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                {% if category.children.exists %}
                <div class="subcategories ps-4 border-start ms-4" style="display: none;">
                    {% for child in category.children.all %}
                    <div class="category-item-wrapper" data-category-name="{{ child.name|lower }}" data-category-code="{{ child.code|default:'' }}">
                        <div class="category-item">
                            <div class="category-info">
                                <div class="category-icon {% if child.has_excel %}has-excel{% else %}no-excel{% endif %}">
                                    {% if child.has_excel %}
                                    <i class="las la-folder-open"></i>
                                    {% else %}
                                    <i class="las la-folder"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="category-name">{{ child.name }}</div>
                                    <div class="category-meta">
                                        {% if child.code %}<span class="badge bg-light text-dark me-2">{{ child.code }}</span>{% endif %}
                                        {% if child.has_excel %}<span class="badge bg-success-subtle text-success">Has Data</span>{% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="category-actions">
                                <a href="{% url 'voters:category_detail' child.pk %}" class="btn btn-icon btn-soft-primary" title="View">
                                    <i class="las la-eye"></i>
                                </a>
                                {% if child.children.exists %}
                                <button type="button" class="btn btn-icon btn-soft-secondary toggle-children" 
                                        onclick="toggleChildren(this)" title="Toggle">
                                    <i class="las la-chevron-down"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if child.children.exists %}
                        <div class="subcategories ps-4 border-start ms-4" style="display: none;">
                            {% for subchild in child.children.all %}
                            <div class="category-item-wrapper" data-category-name="{{ subchild.name|lower }}" data-category-code="{{ subchild.code|default:'' }}">
                                <div class="category-item">
                                    <div class="category-info">
                                        <div class="category-icon {% if subchild.has_excel %}has-excel{% else %}no-excel{% endif %}">
                                            {% if subchild.has_excel %}<i class="las la-folder-open"></i>{% else %}<i class="las la-folder"></i>{% endif %}
                                        </div>
                                        <div>
                                            <div class="category-name">{{ subchild.name }}</div>
                                            <div class="category-meta">
                                                {% if subchild.code %}<span class="badge bg-light text-dark">{{ subchild.code }}</span>{% endif %}
                                                {% if subchild.has_excel %}<span class="badge bg-success-subtle text-success ms-1">Has Data</span>{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="category-actions">
                                        <a href="{% url 'voters:category_detail' subchild.pk %}" class="btn btn-icon btn-soft-primary">
                                            <i class="las la-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="las la-folder-open"></i>
            </div>
            <h5>No categories yet</h5>
            <p>Run the import command to load voter data and create categories.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle children visibility
function toggleChildren(button) {
    const wrapper = button.closest('.category-item-wrapper');
    const subcategories = wrapper.querySelector('.subcategories');
    const icon = button.querySelector('i');
    
    if (subcategories) {
        if (subcategories.style.display === 'none') {
            subcategories.style.display = 'block';
            icon.classList.remove('la-chevron-down');
            icon.classList.add('la-chevron-up');
        } else {
            subcategories.style.display = 'none';
            icon.classList.remove('la-chevron-up');
            icon.classList.add('la-chevron-down');
        }
    }
}

// Expand all categories
function expandAllCategories() {
    document.querySelectorAll('.subcategories').forEach(el => {
        el.style.display = 'block';
    });
    document.querySelectorAll('.toggle-children i').forEach(icon => {
        icon.classList.remove('la-chevron-down');
        icon.classList.add('la-chevron-up');
    });
}

// Collapse all categories
function collapseAllCategories() {
    document.querySelectorAll('.subcategories').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.toggle-children i').forEach(icon => {
        icon.classList.remove('la-chevron-up');
        icon.classList.add('la-chevron-down');
    });
}

// Search filter
document.getElementById('categorySearch').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    const items = document.querySelectorAll('.category-item-wrapper');
    let visibleCount = 0;
    
    items.forEach(item => {
        const name = item.dataset.categoryName || '';
        const code = item.dataset.categoryCode || '';
        
        if (query === '' || name.includes(query) || code.includes(query)) {
            item.style.display = 'block';
            visibleCount++;
            // Show parent subcategories
            let parent = item.parentElement;
            while (parent && parent.classList.contains('subcategories')) {
                parent.style.display = 'block';
                parent = parent.parentElement.closest('.subcategories');
            }
        } else {
            item.style.display = 'none';
        }
    });
    
    document.getElementById('categoryCount').textContent = visibleCount + ' categories';
});
</script>
{% endblock %}
